---
  chain:
    - # Outputs lookup_node_ip.result[0]
      name: get_node_ip
      ref: linux.dig
      params:
        hostname: "{{hostname}}"
      on-success: get_loadbalancer_id
    -
      name: get_loadbalancer_id
      ref: st2.key.get
      params:
        key: "{{asg}}_loadbalancer_id"
      on-success: get_vm_id
    -
      name: get_zone_id
      ref: st2.key.get
      params:
        key: "{{asg}}_zone_id"
      on-success: get_record_id
    -
      name: get_record_id
      ref: libcloud.get_record_id
      params:
        hostname: "{{hostname}}"
        zone_id: "{{get_zone_id.result}}"
      on-success: get_vm_id
    -
      name: get_vm_id
      ref: libcloud.get_vm_id
      params:
        hostname: "{{hostname}}"
        credentials: rax_compute
      on-success: remove_node_loadbalancer
    -
      name: remove_node_loadbalancer
      ref: rackspace.delete_node_from_loadbalancer
      params:
        loadbalancer_id: "{{lookup_loadbalancer_id.result}}"
        ip: "{{lookup_node_ip.result[0]}}"
      on-success: destroy_vm
    -
      name: destroy_vm
      ref: libcloud.destroy_vm
      params:
        credentials: rax_compute
        vm_id: "{{lookup_vm_id.result}}"
      on-success: remove_dns_record
    -
      name: remove_dns_record
      ref: libcloud.delete_dns_record
      params:
        credentials: rax_dns
        record_id: "{{get_record_id.result}}"
        zone_id: "{{get_zone_id.result}}"
  default: get_node_ip

